INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (1, '主机状态检查明细', NULL, 'var datas = eval(\'${hostStatus.metrics}\');\r\nif (!isArray(datas) || datas.length == 0 || !datas[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\ndatas = datas[0].value;\r\nvar pageSize=5;\r\ndivMetric.datagrid({\r\n    //title:\'${title}\',\r\n    fitColumns: true,\r\n    rownumbers: true,\r\n    singleSelect: true,\r\n    remoteSort:false,\r\n    sortName:\"status\",\r\n    sortOrder:\"asc\",\r\n    pagination: pageSize < datas.length,\r\n    pageSize:pageSize,\r\n    pageList: getPageList(pageSize),\r\n    columns:[[\r\n        {field:\'name\',title:\'主机\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'ip\',title:\'IP\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'status\',title:\'状态\',align:\'center\',halign:\'center\',sortable:\"true\",styler:function (value,row,index){return getHostStateStyle(value);}},\r\n        {field:\'lastCheck\',title:\'最后检查时间\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'duration\',title:\'运行时长\',align:\'center\',halign:\'center\'},\r\n        {field:\'statusInformation\',title:\'状态信息\',align:\'left\',halign:\'center\'}\r\n    ]],\r\n    data:datas\r\n}).datagrid(\'clientPaging\');', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (2, '服务状态检查明细', NULL, 'var hostMetrics = eval(\'${hostService.metrics}\'),datas=[];\r\nif (!isArray(hostMetrics) || hostMetrics.length == 0 || !hostMetrics[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nhostMetrics = hostMetrics[0].value;\r\nfor(var i=0,iLen=hostMetrics.length;i<iLen;++i){\r\n    var hostMetric = hostMetrics[i];\r\n    for(var j=0,jLen=hostMetric.services.length;j<jLen;++j){\r\n        hostMetric.services[j].host = hostMetric.name;\r\n        datas.push(hostMetric.services[j]);\r\n    }\r\n}\r\nvar pageSize=5;\r\ndivMetric.datagrid({\r\n    //title:\'${title}\',\r\n    fitColumns: true,\r\n    rownumbers: true,\r\n    singleSelect: true,\r\n    remoteSort:false,\r\n    sortName:\"status\",\r\n    sortOrder:\"asc\",\r\n    pagination: pageSize < datas.length,\r\n    pageSize:pageSize,\r\n    pageList: getPageList(pageSize),\r\n    columns:[[\r\n        {field:\'name\',title:\'服务\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'host\',title:\'主机\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'status\',title:\'服务状态\',align:\'center\',halign:\'center\',sortable:\"true\",styler:function (value,row,index){return getServiceStateStyle(value);}},\r\n        {field:\'lastCheck\',title:\'最后检查时间\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'duration\',title:\'运行时长\',align:\'center\',halign:\'center\'},\r\n        {field:\'statusInformation\',title:\'状态信息\',align:\'left\',halign:\'center\'}\r\n    ]],\r\n    data:datas\r\n}).datagrid(\'clientPaging\');', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (3, '主机状态', NULL, 'var propName=\'${request.propName}\',propTitle=\'${request.propTitle}\',filter=\'${request.filter}\',hostTypes = eval(\'${hostType.metrics}\'),hostStatus = eval(\'${hostStatus.metrics}\');\r\nvar types={},hostMetrics={},datas = [],filters = filter.split(\"|\",2),filterType=filterValue=undefined;\r\nif (!isArray(hostTypes) || hostTypes.length == 0 || !hostTypes[0].value\r\n    || !isArray(hostStatus) || hostStatus.length == 0 || !hostStatus[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nhostTypes = hostTypes[0].value;\r\nhostStatus = hostStatus[0].value;\r\nif (!propName) propName = \'grouptype\';\r\nif (!propTitle) propTitle = \'类型\';\r\nfor(var i=0,iLen=hostStatus.length;i<iLen;++i){\r\n    var aStatus = hostStatus[i];\r\n    if (!hostMetrics[aStatus.name]){\r\n        hostMetrics[aStatus.name] = aStatus;\r\n    }\r\n}\r\n\r\nif (filters.length == 2){\r\n    filterType = filters[0];\r\n    filterValue = filters[1];\r\n}\r\nfor(var i=0,iLen=hostTypes.length;i<iLen;++i){\r\n    var hostType = hostTypes[i];\r\n    if (filterType && filterValue != hostType[filterType]) continue;\r\n    if(!types[hostType[propName]]){\r\n        types[hostType[propName]] = {up:0,down:0,outline:0,name:hostType[propName]};\r\n    }\r\n    var aStatus = hostMetrics[hostType.hostname];\r\n    if (!aStatus){\r\n        types[hostType[propName]].outline += 1;\r\n    }else if (aStatus.status == \'UP\'){\r\n        types[hostType[propName]].up += 1;\r\n    }else{\r\n        types[hostType[propName]].down += 1;\r\n    }\r\n}\r\n\r\nfor(var propertyName in types){\r\n    datas.push(types[propertyName]);\r\n}\r\n\r\nvar pageSize = 5;\r\ndivMetric.datagrid({\r\n    //title:\'${title}\',\r\n    fitColumns: true,\r\n    rownumbers: true,\r\n    singleSelect: true,\r\n    remoteSort:false,\r\n    sortName:\"down\",\r\n    sortOrder:\"desc\",\r\n    pagination:pageSize < datas.length,\r\n    pageSize:pageSize,\r\n    pageList: getPageList(pageSize),\r\n    columns:[[\r\n        {field:\'name\',title:propTitle,align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'up\',title:\'在线数\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'down\',title:\'宕机数\',align:\'center\',halign:\'center\',sortable:\"true\",styler:function (value,row,index){if (value) return getHostStateStyle(\"DOWN\");}},\r\n        {field:\'outline\',title:\'手工下线数\',align:\'center\',halign:\'center\',sortable:\"true\",styler:function (value,row,index){if (value) return getHostStateStyle(\"OUT\");}}\r\n    ]],\r\n    data:datas\r\n}).datagrid(\'clientPaging\');', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (4, '主机服务状态列表', NULL, 'var hostMetrics = eval(\'${hostService.metrics}\'),metrics=[];\r\nif (!isArray(hostMetrics) || hostMetrics.length == 0 || !hostMetrics[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nhostMetrics = hostMetrics[0].value;\r\nfor(var i=0,iLen=hostMetrics.length;i<iLen;++i){\r\n    var hostMetric = hostMetrics[i],ok=0,error=0;\r\n    for(var j=0,jLen=hostMetric.services.length;j<jLen;++j){\r\n        if (hostMetric.services[j].status == \'\'){\r\n            ++ok;\r\n        }else{\r\n            ++error;\r\n        }\r\n    }\r\n    metrics.push({host:hostMetric.name,ok:ok,error:error});\r\n}\r\nvar pageSize=5;\r\ndivMetric.datagrid({\r\n    //title:\'${title}\',\r\n    fitColumns: true,\r\n    rownumbers: true,\r\n    singleSelect: true,\r\n    remoteSort:false,\r\n    sortName:\"error\",\r\n    sortOrder:\"desc\",\r\n    pagination: pageSize < metrics.length,\r\n    pageSize:pageSize,\r\n    pageList: getPageList(pageSize),\r\n    columns:[[\r\n        {field:\'host\',title:\'主机\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'ok\',title:\'正常服务数\',align:\'center\',halign:\'center\',sortable:\"true\"},\r\n        {field:\'error\',title:\'异常服务数\',align:\'center\',halign:\'center\',sortable:\"true\",styler:function (value,row,index){if (value) return getServiceStateStyle(\"CRITICAL\");}}\r\n    ]],\r\n    data:metrics\r\n}).datagrid(\'clientPaging\');', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (5, '主机信息', NULL, 'var propName=\'${request.propName}\',propTitle=\'${request.propTitle}\',filter=\'${request.filter}\',hostTypes = eval(\'${hostType.metrics}\'),hostInfos = eval(\'${hostInfo.metrics}\');\r\nvar filters = filter.split(\"|\",2),filterType=filterValue=undefined;\r\nif (filters.length == 2){\r\n    filterType = filters[0];\r\n    filterValue = filters[1];\r\n}\r\nif (!isArray(hostTypes) || hostTypes.length == 0 || !hostTypes[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nhostTypes = hostTypes[0].value;\r\nif (!isArray(hostInfos) || hostInfos.length == 0 || !hostInfos[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nhostInfos = hostInfos[0].value;\r\nvar datas=[],merges=[],hostClusters = {},dataIndex = 0,url=apiUrlPrefix + \"/api/v1/ops/cluster/metric\";\r\nfor (var i = 0, iLen = hostTypes.length; i < iLen; i++) {\r\n    var hostType = hostTypes[i];\r\n    if (filterType && filterValue != hostType[filterType]) continue;\r\n    hostClusters[hostTypes[i].hostname] = hostType.cluster;\r\n}\r\nfor (var i = 0,iLen = hostInfos.length; i < iLen; i++) {\r\n    var hostInfo = hostInfos[i],disks=hostInfo.disk.split(\":\"),params = {c:hostClusters[hostInfo.hostname],h:hostInfo.hostname};\r\n    if (!params.c) continue;\r\n    merges.push({index:dataIndex,rowspan:disks.length});\r\n    for (var j = 0, jLen = disks.length; j < jLen; j++) {\r\n        var diskname = disks[j],diskused = getLatestGangliaMetricValue(url,diskname + \"-disk_used\",params),\r\n            disktotal = getLatestGangliaMetricValue(url,diskname + \"-disk_total\",params),diskused = diskused ? diskused:0,disktotal = disktotal ? disktotal:0;\r\n        datas.push({name:hostInfo.hostname,cpu:hostInfo.cpu,mem:hostInfo.mem,disk:diskname,diskfree:100-diskused,diskused:diskused,disktotal:disktotal});\r\n        ++dataIndex;\r\n    }\r\n}\r\nfunction onLoadSuccess(data){\r\n    for(var i=0; i<merges.length; i++){\r\n        $(this).datagrid(\'mergeCells\',{\r\n            index: merges[i].index,\r\n            field: \'name\',\r\n            rowspan: merges[i].rowspan\r\n        }).datagrid(\'mergeCells\',{\r\n            index: merges[i].index,\r\n            field: \'cpu\',\r\n            rowspan: merges[i].rowspan\r\n        }).datagrid(\'mergeCells\',{\r\n            index: merges[i].index,\r\n            field: \'mem\',\r\n            rowspan: merges[i].rowspan\r\n        });\r\n    }\r\n}\r\nvar pageSize=5;\r\ndivMetric.datagrid({\r\n    //title:\'${title}\',\r\n    fitColumns: true,\r\n    rownumbers: true,\r\n    singleSelect: true,\r\n    remoteSort:false,\r\n    //sortName:\"error\",\r\n    //sortOrder:\"desc\",\r\n    //pagination: pageSize < datas.length,\r\n    //pageSize:pageSize,\r\n    pageSize:datas.length,\r\n    pageList: getPageList(pageSize),\r\n    onLoadSuccess: onLoadSuccess,\r\n    columns:[[\r\n        {field:\'name\',title:\'主机\',align:\'center\',halign:\'center\'},\r\n        {field:\'cpu\',title:\'CPU\',align:\'center\',halign:\'center\'},\r\n        {field:\'mem\',title:\'内存\',align:\'center\',halign:\'center\'},\r\n        {field:\'disk\',title:\'磁盘块\',align:\'center\',halign:\'center\'},\r\n        {field:\'disktotal\',title:\'总空间(GB)\',align:\'center\',halign:\'center\',formatter: function(value,row,index){return storageSpaceAdapt(value,\"G\").value;}},\r\n        {field:\'diskused\',title:\'已用空间(%)\',align:\'center\',halign:\'center\',formatter: function(value,row,index){return value + \"%\";}}\r\n    ]],\r\n    data:datas\r\n}).datagrid(\'clientPaging\');', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (6, '指标报表折线图', NULL, 'var metricName=\'${request.m}\',metricReport=eval(\'${metricReport.metrics}\');\r\nvar filters=[];\r\nif (!isArray(metricReport) || metricReport.length == 0 || !metricReport[0].value){\r\n    divMetric.html(\'<label>加载失败！</label>\');\r\n    return;\r\n}\r\nmetricReport = metricReport[0].value;\r\n\r\nfunction initClusterEcharts (ec) { \r\n    setTimeout(function(){doInitCluster(ec);},50);       \r\n}\r\nfunction doInitCluster (ec) {\r\n	var datas = getEchartsReportDatas(metricName,metricReport,\"line\",undefined),\r\n    mychart = createLine(ec,divMetric.attr(\"id\"),datas,filters,metricName);\r\n	$(window).resize(function(){\r\n	    mychart.resize(); \r\n	});\r\n}\r\n// 路径配置\r\nrequire.config({\r\n    paths: {\r\n        echarts: \'js/echarts\'\r\n    }\r\n});\r\n// 使用\r\nrequire(\r\n    [\r\n        \'echarts\',\r\n        \'echarts/chart/pie\', // 按需加载\r\n        \'echarts/chart/line\', // 按需加载\r\n        \'echarts/chart/bar\' // 按需加载\r\n    ],\r\n    initClusterEcharts\r\n);', '1');
INSERT INTO `T_WEB_METRIC_TEMPLATE` (`TEMPLATE_ID`, `TEMPLATE_NAME`, `TEMPLATE_CONTENT`, `TEMPLATE_SCRIPT`, `IS_VALID`) VALUES (7, '指标报表饼图', NULL, NULL, '1');
